<%- include('../../views/partials/user/header') %>
<!-- Add these in the head tag -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css"/>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />

<style>
.TotalAmount{
  font-size: 16px;
  font-weight: 500;
}

    /* Add your existing CSS styles here */
    #addressFormContainer {
        display: none;
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #ffff;
    }

    #showFormBtn + #addressFormContainer {
        display: block;
    }

    input[type="text"] {
        width: 400px;
        height: 50px;
       
        margin-bottom: 20px;
        padding-left: 20px;
        border: 1px solid #0000002a;
        border-radius: 4px;
    }

    label {
        padding-top: 20px;
        padding-bottom: 5px;
        font-weight: 600;
    }

    .list-group {
        border-radius: 4px;
        margin-left: 20px;
        padding-left: 20px;
        
    }

  .coupon-container {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  padding: 10px 0;

  
}
    .coupon {
    
    width: 400px;
    height: 200px;
    border-radius: 10px;
    overflow: hidden;
    margin: auto;
    filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.5));
    display: flex;
    align-items: stretch;
    position: relative;
    text-transform: uppercase;
  }
.coupon-description{
  padding-top: 10px;
  font-size: 10px;
  color: #000;
}
  .coupon::before,
  .coupon::after {
    content: "";
    position: absolute;
    top: 0;
    width: 50%;
    height: 100%;
    z-index: -1;
  }

  .coupon::before {
    left: 0;
    background-image: radial-gradient(circle at 0 50%, transparent 25px, #fca311 26px);
  }

  .coupon::after {
    right: 0;
    background-image: radial-gradient(circle at 100% 50%, transparent 25px, #fca311  26px);
  }

  .coupon > div {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .left {
    width: 20%;
    border-right: 2px dashed rgba(0, 0, 0, 0.13);
  }

  .left div {
    transform: rotate(-90deg);
    white-space: nowrap;
    font-weight: bold;
  }

  .center {
    flex-grow: 1;
    text-align: center;
    padding: 10px;
    margin-top: 10px;
  }

  .right {
    width: 120px;
    background-image: radial-gradient(circle at 100% 50%, transparent 25px, #fff 26px);
  }

  .right div {
    font-size: 12px;
    font-weight: 500;
    transform: rotate(-90deg);
  }

  .center h2 {
    background: #000;
    color: #fff;
    padding-top:10px;
    font-size: 1rem;
    white-space: nowrap;
  }

  .center h3 {
    font-size: 1.5rem;
    padding: 10px;
  }

  .center small {
    font-size: 0.625rem;
    font-weight: 600;
    letter-spacing: 1px;
  }

  .copy-btn {
    background-color: transparent;
    color: #000;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;    
    display: inline-flex;
    align-items: center;
  }

  .copy-btn i {
    margin-right: 5px;
  }

  .copy-btn:hover {
    background-color: transparent;
  }



  @media screen and (max-width: 500px) {
    .coupon {
      display: grid;
      grid-template-columns: 1fr;
    }

    .left div {
      transform: rotate(0deg);
    }

    .right div {
      transform: rotate(0deg);
    }
  }

  @media screen and (max-width:500px){
    .coupon {
      display:grid;
      grid-template-columns:1fr;
    }
    .left div {
      transform: rotate(0deg);
    }
    .right div {
      transform: rotate(0deg);
    }
  }

    

    .model-form {
        margin-top: 50px;
    }

    h6 {
        font-weight: 600;
    }

    .checkout__form {
        display: flex;
        justify-content: space-between;

    }

    .col-lg-8 {
        flex: 0 0 60%;
        max-width: 60%;
    }

    .col-lg-4 {
        flex: 0 0 35%;
        max-width: 35%;
        position: relative;
        right: 0;
    }

    .more-options {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .more-options .btn {
        padding: 0;
        background: transparent;
        border: none;
        cursor: pointer;
        color: inherit;
    }

    .more-options i {
        color: #333;
    }

    .more-options .btn:hover i {
        color: #000;
    }

    .dropdown-list {
        display: none;
        position: absolute;
        right: 0;
        top: 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
        width: 100px;
        z-index: 10;
    }

    .more-options:hover .dropdown-list {
        display: block;
    }

    .dropdown-item {
        padding: 8px 12px;
        text-decoration: none;
        color: #333;
        cursor: pointer;
        display: block;
        font-size: 14px;
    }

    .dropdown-item:hover {
        background-color: #f0f0f0;
        color: rgba(0, 0, 255, 0.616);
    }

    .order-details-box {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
        width: 50%;
        margin-top: 40px;
        margin-left: 50px;
    }

    .order-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .order-summary-item p {
        margin: 0;
        font-size: 16px;
        color: #333;
    }

    .save-address {
        background-color: #000;
        color: #fff;
        margin-top: 10px;
    }

    .save-address:hover {
        border: 1px solid #000;
        background-color: #fff;
        color: #000;
    }

    .radio-btn{
        position:absolute;
        top: 15px;
        right: 97.5%;
    }
#couponCode-form{
  margin-left: 50px;
}
   
</style>

<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Check Out</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/products">Product</a>
                        <span>Check Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="checkout spad">
    <div class="container-checkout">
        <div class="checkout__form d-flex justify-content-between">
            <!-- Left Section: Address List -->
            <div class="col-lg-8">
                <% if (address.length === 0 || !address.some(doc => doc.address.length > 0)) { %>
                    <div class="text-center">
                        <p class="fs-4">There is no address available. <br> <button class="save-address btn" id="showFormBtn">Add New Address</button></p>
                    </div>
                <% } else { %>
                    <!-- Display existing addresses -->
                    <h3 class="mb-4">Your Addresses</h3>
                    <ul class="list-group mb-4">
                        <% address.forEach(function(doc) { %>
                            <% doc.address.forEach(function(addr) { %>
                                
                                <li class="list-group-item pl-4">
                                    <div class="address-option">
                                        <input class="radio-btn "  type="radio" name="selectedAddress" value="<%= addr._id %>"> 
                                    </div>
                                    
                                    <h6><%= addr.recipient_name %>
                                        <% if (addr.addressType) { %>
                                            <span class="badge badge-warning mb-2"><%=addr.addressType%></span>
                                        <% } %>
                                    </h4>
                                    <strong><%= addr.streetAddress %>, <%= addr.city %>, <%= addr.state %></strong><br>
                                    Pincode: <%= addr.pincode %> <br>
                                    Landmark: <%= addr.landMark || 'N/A' %><br>
                                    <span class="text-muted">Phone: <%= addr.phone || 'N/A' %></span>
                                    <div class="more-options">
                                    <button class="btn btn-link"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                    <div class="dropdown-list">
                                      <ul>
                                      <li><a href="#" class="dropdown-item edit-address" data-id="<%= addr._id %>">Edit</a>
                                     </ul>
                                    </div>
                                    </div>
                                </li>
                            <% }); %>
                        <% }); %>
                    </ul>
                    <button class="save-address btn" id="showFormBtn">Add New Address</button>
                <% } %>

                <button id="continueWithAddress" type="submit"  class="btn btn-dark mt-3 mb-1">
                    Continue
                </button>
            
                <!-- Address Form (Initially Hidden) -->
                <div class="mt-5" id="addressFormContainer" style="display: none;">
                    <h2 class="mb-4">Add New Address</h2>
                    <form id="addressForm" action="/save-address" method="post">
                      <input type="hidden" id="actionType" name="actionType" value="add">
            
                        <div class="mb-3">
                            <label for="name" class="form-label">Name<span class="text-danger">*</span> </label>
                            <input type="text" class="form-control" id="recipient_name" name="recipient_name">
                            <div id="error1" class="error-message"></div>
                        </div>
                        <div class="mb-3">
                            <label for="streetAddress" class="form-label">Street Address <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="streetAddress" name="streetAddress">
                            <div id="error2" class="error-message"></div>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="city" name="city">
                            <div id="error3" class="error-message"></div>
                        </div>
                        <div class="mb-3">
                            <label for="state" class="form-label">State <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="state" name="state">
                            <div id="error4" class="error-message"></div>
                        </div>
                        <div class="mb-3">
                            <label for="landMark" class="form-label">Landmark (Optional)</label>
                            <input type="text" class="form-control" id="landMark" name="landMark">
                        </div>
                        <div class="mb-3">
                            <label for="pincode" class="form-label">Pincode <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="pincode" name="pincode">
                            <div id="error5" class="error-message"></div>
                        </div>
            
                        <div class="mb-3">
                            <label for="Phone" class="form-label">Phone No <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" name="phone"  placeholder="10-digit phone number">
                            <div id="error6" class="error-message"></div>
                        </div>
                        <div class="mb-3">
                            <label for="altPhone" class="form-label">Alternate Phone (Optional)</label>
                            <input type="tel" class="form-control" id="altPhone" name="altPhone"  placeholder="10-digit phone number">
                        </div>
            
                        <div class="mb-3">
                            <label class="form-label">Address Type <span class="text-danger">*</span></label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input mt-3" type="radio" name="addressType" id="home" value="Home">
                                <label class="form-check-label" for="home">Home</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input mt-3" type="radio" name="addressType" id="work" value="Work">
                                <label class="form-check-label" for="work">Work</label>
                            </div>
                            <div id="error7" class="error-message"></div>
                        </div>
            
                        <button type="submit" id="submit-btn" class="save-address btn">Add Address</button>
                    </form>
                    </div>
                </div>
    
<!-- Right Section: Order Details -->

<div class="coupon-carousel-container">
  <% if (coupons.length === 0) { %>
    <div class="alert alert-warning text-center">
      No coupons available for the products in your cart.
    </div>
  <% } else { %>
    <h6 class="mb-2">Available Coupons</h6>
    <div id="couponCarousel" class="carousel slide" data-ride="carousel">
      <div class="carousel-inner">
        <% coupons.forEach((coupon, index) => { %>
          <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
            <div class="coupon">
              <div class="left">
                <div>Enjoy Your Gift</div>
              </div>
              <div class="center">
                <div>
                  <h2>
                    <%= coupon.discountType === 'percentage' 
                      ? `${coupon.discountValue}%` 
                      : `₹${coupon.discountValue}` %> OFF
                  </h2>
                  <p class="coupon-description"><%= coupon.description %></p>
                 
                  <div class="coupon-code">
                    <button class="copy-btn" data-code="<%= coupon.code %>" title="Copy Code">
                      <i class="fas fa-copy"></i> Copy
                    </button>
                    <p><%= coupon.code %></p>
                  </div>
                  <small>Valid Till: <%= new Date(coupon.endDate).toDateString() %></small>
                  <small class="text-muted">Min Order: ₹<%= coupon.minOrderValue %></small>
                </div>
              </div>
              <div class="right">
                <div class="paypal__footer">
                  <img src="https://i.ibb.co/c8CQvBq/barcode.png" alt="Paypal Barcode" class="paypal__barcode">
                  <p>FusionGear.com</p>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
      <!-- Controls -->
      <a class="carousel-control-prev" href="#couponCarousel" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="carousel-control-next" href="#couponCarousel" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
  <% } %>
</div>
        </div>
    
<div class="order-details-box">
  <h6>Order Summary</h6>
  <div class="order-summary-item">
      <p>Items:</p>
      <span id="cartCount"><%= cartCount%> items</span>
  </div>
  <div class="order-summary-item">
    <p>Product Price:</p>
    <span id="cartTotal" class="TotalAmount">₹ <%=totalSalePrice %></span>
</div>
  
  <div class="order-summary-item">
    <p>Offer Discount:</p>
    <span id="offerDiscount"  class="text-success">-₹<%= offerDiscount %></span>
</div>

<div class="order-summary-item">
  <p>Subtotal:</p>
  <span id="cartTotal" class="TotalAmount">₹ <%=cartTotal %></span>
</div>

<div class="order-summary-item">
    <p>Coupon Discount:</p>
    <span id="couponDiscount" class="text-success">-₹<%= couponDiscount %></span>
</div>
  <div class="order-summary-item">
      <p>Shipping:</p>
      <span id="shippingCharges"  class="text-danger">₹<%= shippingCharges  %></span>
  </div>
  <div class="order-summary-item">
      <p>Total:</p>
      <span id="netAmount"  class="TotalAmount">₹<%= netAmount%></span>
  </div>
</div>

        <!-- Apply Coupon Section -->
        <h6 class="mt-4 ml-5 mb-3">Apply Coupon</h6>
        <div id="coupon-section">
                <form id="couponCode-form" action="/checkout" method="GET">
                  <input type="text" id="couponCode" name="couponCode" placeholder="Enter coupon code"/>
                  <button type="submit" class="btn btn-primary">Apply Coupon</button>
                  <div id="couponCode-error" class="error-message"></div>
              </form>
        
      </div>
 </div>
</div>
        </div>
</section>


<!-- Add these before closing the body tag -->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>



<script>
function removeCoupon() {
    $.ajax({
        url: '/remove-coupon',
        method: 'POST',
        success: function(response) {
            updateOrderSummary(response);

            // Update the coupon section dynamically
            const couponSection = document.getElementById('coupon-section');
            couponSection.innerHTML = `
                <form id="couponCode-form" action="/checkout" method="GET">
                    <input type="text" id="couponCode" name="couponCode" placeholder="Enter coupon code" required />
                    <button type="submit" class="btn btn-primary">Apply Coupon</button>
                    <div id="couponCode-error" class="error-message"></div>
                </form>
            `;

            toastr.success("Coupon removed successfully!");
        },
        error: function(error) {
            console.error('Error removing coupon:', error);
            toastr.error('An error occurred while removing the coupon. Please try again.');
        }
    });
}

// Function to update the order summary dynamically
function updateOrderSummary(data) {
    document.getElementById('cartTotal').innerText = `₹ ${data.cartTotal}`;
    document.getElementById('offerDiscount').innerText = `-₹ ${data.offerDiscount}`;
    document.getElementById('couponDiscount').innerText = `-₹ ${data.couponDiscount}`;
    document.getElementById('shippingCharges').innerText = `₹ ${data.shippingCharges}`;
    document.getElementById('netAmount').innerText = `₹ ${data.netAmount}`;
    document.getElementById('cartCount').innerText = `${data.cartCount} items`;
}


</script>


<script>
  $('#couponCarousel').carousel({
  interval: 3000, 
  ride: 'carousel', 
});


</script>

<script>
    document.getElementById('couponCode-form').addEventListener('submit', async function(e) {
    e.preventDefault(); // Prevent the default form submission
    
    let couponCode = document.getElementById('couponCode').value.trim();
    let error = document.getElementById('couponCode-error');
    
    // Clear previous error message
    error.innerText = "";
    
    // Clear previous success/failure messages
    toastr.clear();
    
    if (couponCode === '') {
        error.innerText = "Coupon code is required";
        return;
    }
    
    // Send the coupon code to the backend for validation
    try {
        const response = await fetch(`/checkout/apply-coupon?couponCode=${couponCode}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        // Check if response is successful and handle it
        if (!response.ok) {
            const errorData = await response.json();
            toastr.error(errorData.error || errorData.couponMessage);
            return;
        }

        const data = await response.json();
        console.log("Server Response:", data); // Log the response from the server

        if (data.couponMessage) {
            toastr.error(data.couponMessage);
        } else {
            // Successfully applied the coupon
            toastr.success(`Coupon code "${couponCode}" applied successfully!`);
            updateOrderSummary(data);

            // Update the coupon section dynamically
            const couponSection = document.getElementById('coupon-section');
            couponSection.innerHTML = `
                <div id="applied-coupon">
                    <p>Applied Coupon: <strong>${couponCode}</strong></p>
                    <button id="remove-coupon-btn" class="btn btn-danger" onclick="removeCoupon()">Remove Coupon</button>
                </div>
            `;
        }
    } catch (err) {
        // Handling error during coupon application
        toastr.error(`An error occurred while applying the coupon: ${err.message}`);
        console.error("Error applying coupon:", err);
    }
});


function updateOrderSummary(data) {
    document.getElementById('cartTotal').innerText = `₹ ${data.cartTotal}`;
    document.getElementById('offerDiscount').innerText = `-₹ ${data.offerDiscount}`;
    document.getElementById('couponDiscount').innerText = `-₹ ${data.couponDiscount}`;
    document.getElementById('shippingCharges').innerText = `₹ ${data.shippingCharges}`;
    document.getElementById('netAmount').innerText = `₹ ${data.netAmount}`;
    document.getElementById('cartCount').innerText = `${data.cartCount} items`;
}

    </script>
    

<script>


const addressForm = document.getElementById('addressFormContainer')
const recipient_name = document.getElementById('recipient_name')
const streetAddress = document.getElementById('streetAddress')
const city = document.getElementById('city')
const state = document.getElementById('state')
const pincode = document.getElementById('pincode')
const phone = document.getElementById('phone');

const err1 = document.getElementById('error1')
const err2 = document.getElementById('error2')
const err3 = document.getElementById('error3')
const err4 = document.getElementById('error4')
const err5 = document.getElementById('error5')
const err6 = document.getElementById('error6')


const addressTypeInputs = document.getElementsByName('addressType');
const err7 = document.getElementById('error7');

function addressTypeValidation() {
const addressTypeInputsArray = Array.from(addressTypeInputs);
const isSelected = Array.isArray(addressTypeInputsArray) && addressTypeInputsArray.some(input => input.checked);

if (!isSelected) {
    err7.innerText = "Please select an address type";
} else {
    err7.innerText = "";
}
}

addressTypeInputs.forEach(input => input.addEventListener('change', addressTypeValidation));


function nameValidation(){
const nameVal = recipient_name.value.trim();
const namePattern = /^[a-zA-Z\s]{2,50}$/;
if (nameVal === "") {
    err1.innerText = "Please enter the full name";
} else if (!namePattern.test(nameVal)) {
    err1.innerText = "Name can only contain alphabets and spaces";
} else {
    err1.innerText = "";
}
}

recipient_name.addEventListener('blur',nameValidation)
streetAddress.addEventListener('blur',addressValidation)
city.addEventListener('blur',addressValidation)
state.addEventListener('blur',addressValidation)
pincode.addEventListener('blur',addressValidation)
phone.addEventListener('blur',addressValidation)
altPhone.addEventListener('blur',addressValidation)

function addressValidation(){
const streetVal = streetAddress.value.trim()
const cityVal = city.value.trim();
const stateVal = state.value.trim();
const pincodeVal = pincode.value.trim();
const phoneVal = phone.value.trim()
const phonePattern = /^(\+\d{1,3}[- ]?)?\d{10}$/;
const pincodePattern = /^\d{6}$/;
const allZero = /^0+$/;



if (streetVal === "") {
    err2.innerText = "Please enter street address";
} else {
    err2.innerText = "";
}

if (cityVal === "") {
    err3.innerText = "Please enter city";
} else {
    err3.innerText = "";
}

if (stateVal === "") {
    err4.innerText = "Please enter state";
} else {
    err4.innerText = "";
}

if (!pincodePattern.test(pincodeVal)) {
    err5.innerText = "Enter a valid 6-digit pincode";
} else if(allZero.test(pincodeVal)){
    err5.innerText = "Pincode cannot be all zeros!";
}else {
    err5.innerText = "";
}

if (allZero.test(phoneVal)) {
    err6.innerText = "Phone number cannot be all zeros!";
} else if (!phonePattern.test(phoneVal)) {
    err6.innerText = "Enter a valid phone number";
} else {
    err6.innerText = "";
}


}
document.getElementById('addressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // Perform validation
  nameValidation();
  addressValidation();
  addressTypeValidation();

  const hasError = [err1, err2, err3, err4, err5, err6, err7].some(err => err.innerText !== "");
  if (hasError) {
    return;
  }

  const actionType = document.getElementById('actionType').value;
  const addressId = actionType === 'update' ? document.getElementById('addressId').value : null;
  const addressTypeElement = document.querySelector('input[name="addressType"]:checked');
  const addressType = addressTypeElement ? addressTypeElement.value : null;

  console.log(addressId)
  const addressData = {
    recipient_name: document.getElementById('recipient_name').value.trim(),
    streetAddress: document.getElementById('streetAddress').value.trim(),
    city: document.getElementById('city').value.trim(),
    state: document.getElementById('state').value.trim(),
    landMark: document.getElementById('landMark').value.trim(),
    pincode: document.getElementById('pincode').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    altPhone: document.getElementById('altPhone').value.trim(),
    addressType: addressType,
  };

  const url = actionType === 'update'
    ? `/update-address/${addressId}`
    : document.getElementById('addressForm').action;

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(addressData),
    });

    const responseText = await response.text();
    console.log('Response text:', responseText);

    if (response.ok) {
      const responseData = JSON.parse(responseText);
      Swal.fire({
        title: 'Success!',
        text: responseData.message,
        icon: 'success',
        confirmButtonText: 'OK',
      }).then(() => {
        location.reload();
      });
    } else {
      const errorData = JSON.parse(responseText);
      console.error("Server-side error:", errorData);
      Swal.fire({
        title: 'Error!',
        text: errorData.message || 'Failed to add/update the address. Please try again.',
        icon: 'error',
        confirmButtonText: 'OK',
      });
    }
  } catch (error) {
    console.error("Client-side error:", error);
    Swal.fire({
      title: 'Error!',
      text: 'Something went wrong. Please try again later.',
      icon: 'error',
      confirmButtonText: 'OK',
    });
  }
});

</script>


<script>
        document.getElementById('showFormBtn').addEventListener('click', function() {
        const formContainer = document.getElementById('addressFormContainer');
        formContainer.style.display = (formContainer.style.display === 'none' || formContainer.style.display === '') ? 'block' : 'none';
    });


window.addEventListener('load', () => {
  const successMessage = localStorage.getItem('deleteSuccess');
  const errorMessage = localStorage.getItem('deleteError');

  if (successMessage) {
    Swal.fire({
      title: 'Deleted!',
      text:  successMessage,
      icon: 'success',
      confirmButtonText: 'OK'
    });
    localStorage.removeItem('deleteSuccess');
  } else if (errorMessage) {
    Swal.fire({
      title: 'Error!',
      text: errorMessage,
      icon: 'error',
      confirmButtonText: 'OK'
    });
    localStorage.removeItem('deleteError'); 
  }
});

document.querySelectorAll('.edit-address').forEach((editLink) => {
  editLink.addEventListener('click', async (e) => {
    e.preventDefault();
    const addressId = e.target.getAttribute('data-id');
    try {

  const response = await fetch(`/edit-address/${addressId}`);
  console.log('Response Status:', response.status);
  const addressData = await response.json();
  console.log('Address Data:', addressData); 

  if (response.ok) {
    document.getElementById('recipient_name').value = addressData.recipient_name;
    document.getElementById('streetAddress').value = addressData.streetAddress;
    document.getElementById('city').value = addressData.city;
    document.getElementById('state').value = addressData.state;
    document.getElementById('landMark').value = addressData.landMark || '';
    document.getElementById('pincode').value = addressData.pincode;
    document.getElementById('phone').value = addressData.phone;
    document.getElementById('altPhone').value = addressData.altPhone || '';

    // Set the address type (radio button)
    document.querySelectorAll('input[name="addressType"]').forEach((input) => {
      input.checked = input.value === addressData.addressType;
    });

  document.getElementById('addressFormContainer').style.display = 'block';
  document.getElementById('showFormBtn').style.display = "none";
  document.getElementById('submit-btn').innerText = "Update";

  // Ensure the form exists before trying to modify it
  const form = document.getElementById('addressForm');
  if (form) {
    form.action = `/update-address/${addressId}`;
    form.method = 'POST';
  } else {
    console.error('Form not found');
  }
  } else {
    Swal.fire({
      title: "Error!",
      text: response.message || 'Failed to fetch address data. Please try again.',
      icon: 'error',
      confirmButtonText: 'OK'
    });
  }
} catch (error) {
  console.error('Error:', error);
  Swal.fire({
    title: "Error!",
    text: 'Something went wrong. Please try again later.',
    icon: 'error',
    confirmButtonText: 'OK'
  });
}
  });
});



document.getElementById('continueWithAddress').addEventListener('click', async function () {
    const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
    
    if (!selectedAddress) {
        Swal.fire({
            title: 'Error!',
            text: 'Please select an address before proceeding.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }

    const addressId = selectedAddress.value;

    try {
        
        const response = await fetch('/set-selected-address', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ addressId }),
        });

        const responseData = await response.json();
        if (response.ok) {
            window.location.href = '/payment';
        } else {
            Swal.fire({
                title: 'Error!',
                text: responseData.message || 'Failed to select address. Try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Error selecting address:', error);
        Swal.fire({
            title: 'Error!',
            text: 'Something went wrong. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
});


</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const copyButtons = document.querySelectorAll(".copy-btn");

        copyButtons.forEach(button => {
            button.addEventListener("click", function () {
                const couponCode = this.getAttribute("data-code");
                navigator.clipboard.writeText(couponCode).then(() => {
                    // Show success message using Toastr
                    toastr.success(`Coupon Code "${couponCode}" copied to clipboard!`);
                }).catch(err => {
                    // Show error message using Toastr
                    toastr.error("Error copying text: " + err);
                    console.error("Error copying text: ", err);
                });
            });
        });
    });
</script>



<%- include('../../views/partials/user/footer') %>
