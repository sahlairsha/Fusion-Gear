<%- include('../../views/partials/user/header') %>

<style>
    .save-address {
        border: none;
        background-color: black;
        color: #fff;
        width: 160px;
        height: 50px;
        margin-left: 500px;
        border-radius: 4px;
    }

    .edit-address-btn {
        margin-top: 10px;
        margin-left: 49px;
        margin-bottom: 20px;
        background-color: #000;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    input[type="text"] {
        width: 400px;
        height: 50px;
        margin-bottom: 20px;
        padding-left: 20px;
        border: 1px solid #0000002a;
        border-radius: 4px;
    }

    label {
        padding-top: 20px;
        padding-bottom: 5px;
    }

    .model-form {
        margin-top: 50px;
    }

    h6 {
        font-weight: 600;
    }

    .text-danger {
        color: red;
    }

    .error-message {
        color: red;
        margin-bottom: 10px;
    }
</style>

<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Check Out</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/products">Product</a>
                        <span>Check Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="checkout spad">
    <div class="container">
        <div class="checkout__form">
            <form action="#">
                <div class="row">
                    <div class="col-lg-8 col-md-6">
                        <h6 class="checkout__title">Billing Details</h6>
                        <div class="checkout__input">
                            <p>Select Address<span>*</span></p>
                            <select name="address" id="addressSelect">
                                <% if (addresses.length > 0) { %>
                                    <% addresses.forEach(address => { %>
                                        <option value="<%= address._id %>">
                                            <%= address.recipient_name %>, <%= address.streetAddress %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>
                                        </option>
                                    <% }) %>
                                <% } else { %>
                                    <option>No saved addresses</option>
                                <% } %>
                            </select>
                            <button class="edit-address-btn" id="editAddressBtn"><a class="text-decoration-none text-white" href="/address-view">Edit Address</a></button>
                            <button class="save-address" type="button" id="addNewAddressBtn">Add New Address</button>
                        </div>

                        <!-- Modal form to add or edit address -->
                        <div class="model-form" id="newAddressModal" style="display:none;">
                            <h6 id="modalTitle">Add New Address</h6>
                            <label for="newRecipient">Name<span class="text-danger">*</span></label><br>
                            <input type="text" id="newRecipient" placeholder="Recipient Name">
                            <div id="error1" class="error-message"></div>

                            <label for="newStreet">Street Address<span class="text-danger">*</span></label><br>
                            <input type="text" id="newStreet" placeholder="Street Address">
                            <div id="error2" class="error-message"></div>

                            <label for="newCity">City<span class="text-danger">*</span></label><br>
                            <input type="text" id="newCity" placeholder="City">
                            <div id="error3" class="error-message"></div>

                            <label for="newState">State<span class="text-danger">*</span></label><br>
                            <input type="text" id="newState" placeholder="State">
                            <div id="error4" class="error-message"></div>

                            <label for="newPincode">Pincode<span class="text-danger">*</span></label><br>
                            <input type="text" id="newPincode" placeholder="Pincode">
                            <div id="error5" class="error-message"></div>

                            <label for="newPhone">Phone Number<span class="text-danger">*</span></label><br>
                            <input type="text" id="newPhone" placeholder="Phone">
                            <div id="error6" class="error-message"></div><br>

                            <label for="newAltPhone">Alternative Phone (Optional)</label><br>
                            <input type="text" id="newAltPhone" placeholder="Alternative Phone"><br>

                            <label for="newAddressType">Address Type<span class="text-danger">*</span></label><br>
                            <select id="newAddressType">
                                <option value="">Select</option>
                                <option value="Home">Home</option>
                                <option value="Work">Work</option>
                            </select><br>
                            <br><div id="error7" class="error-message"></div>

                            <button class="save-address" type="button" id="saveAddressBtn">Save Address</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
// Event listener for opening the modal to add a new address
document.getElementById('addNewAddressBtn').addEventListener('click', function() {
    document.getElementById('newAddressModal').style.display = ( document.getElementById('newAddressModal').style.display === 'none' ||     document.getElementById('newAddressModal').style.display=== '') ? 'block' : 'none';
    
    document.getElementById('modalTitle').textContent = 'Add New Address';
    document.getElementById('saveAddressBtn').setAttribute('data-edit', 'false');
    if(document.getElementById('newAddressModal').style.display === 'none'){
        document.getElementById('addNewAddressBtn').innerText = "Add New Address"
    }else{
        document.getElementById('addNewAddressBtn').innerText = "Close"
    }
});

// Event listener for selecting an address
document.getElementById('addressSelect').addEventListener('change', function() {
    const selectedAddressId = this.value;
    const editButton = document.getElementById('editAddressBtn');

    if (selectedAddressId) {
        editButton.style.display = 'inline-block';
        editButton.setAttribute('data-id', selectedAddressId); // Set the ID to the button for editing
    } else {
        editButton.style.display = 'none';
    }
});

// Event listener for the edit button
document.getElementById('editAddressBtn').addEventListener('click', function() {
    const addressId = this.getAttribute('data-id');
    // Fetch address details to populate in the form
    const selectedAddress = addresses.find(address => address._id === addressId);

    if (selectedAddress) {
        // Fill the form with the saved address details
        document.getElementById('newRecipient').value = selectedAddress.recipient_name;
        document.getElementById('newStreet').value = selectedAddress.streetAddress;
        document.getElementById('newCity').value = selectedAddress.city;
        document.getElementById('newState').value = selectedAddress.state;
        document.getElementById('newPincode').value = selectedAddress.pincode;
        document.getElementById('newPhone').value = selectedAddress.phone;
        document.getElementById('newAltPhone').value = selectedAddress.altPhone;
        document.getElementById('newAddressType').value = selectedAddress.addressType;
        
        // Display the modal and change title to "Edit Address"
        document.getElementById('newAddressModal').style.display = 'block';
        document.getElementById('modalTitle').textContent = 'Edit Address';
        document.getElementById('saveAddressBtn').setAttribute('data-edit', 'true'); // Editing existing address
    }
});

// Save address button event listener
document.getElementById('saveAddressBtn').addEventListener('click', function(e) {
    const isNameValid = nameValidation();
    const isAddressValid = addressValidation();
    const isAddressTypeValid = addressTypeValidation();

    if (!isNameValid || !isAddressValid || !isAddressTypeValid) {
        e.preventDefault(); // Prevent submission if validation fails
        return;
    }

    const isEditMode = this.getAttribute('data-edit') === 'true';
    const addressData = {
        recipient_name: document.getElementById('newRecipient').value.trim(),
        streetAddress: document.getElementById('newStreet').value.trim(),
        city: document.getElementById('newCity').value.trim(),
        state: document.getElementById('newState').value.trim(),
        pincode: document.getElementById('newPincode').value.trim(),
        phone: document.getElementById('newPhone').value.trim(),
        altPhone: document.getElementById('newAltPhone').value.trim(),
        addressType: document.getElementById('newAddressType').value.trim()
    };

    const url = isEditMode ? '/edit-address' : '/save-address'; // Decide on URL based on edit mode
    const method = isEditMode ? 'PUT' : 'POST'; // PUT for edit, POST for new address

    // Send the data
    fetch(url, {
        method: method,
        body: JSON.stringify(addressData),
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload(); // Reload page after successful save
        } else {
            console.error('Error saving address:', result.message);
        }
    })
    .catch(err => console.error('Error saving address:', err));
});

</script>

<%- include('../../views/partials/user/footer') %>
